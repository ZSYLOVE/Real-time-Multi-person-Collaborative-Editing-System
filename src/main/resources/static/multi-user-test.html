<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç”¨æˆ·åœ¨çº¿ç¼–è¾‘æµ‹è¯•</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-users {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .user-status.offline {
            background: #6c757d;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .top-bar {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .document-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .collaborators {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collaborator-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ç¼–è¾‘å™¨åŒºåŸŸ */
        .editor-area {
            flex: 1;
            display: flex;
            padding: 24px;
            gap: 24px;
        }

        .editor-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .editor-content {
            flex: 1;
            padding: 20px;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            border: none;
            resize: none;
        }

        /* æ“ä½œæ—¥å¿— */
        .operation-log {
            width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .log-header {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }

        .log-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background: white;
            border-left: 3px solid #667eea;
        }

        .log-entry.error {
            border-left-color: #dc3545;
        }

        .log-entry.success {
            border-left-color: #28a745;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 24px 24px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-body {
            padding: 0 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.show {
                left: 0;
            }

            .editor-area {
                flex-direction: column;
            }

            .operation-log {
                width: 100%;
                height: 200px;
            }
        }

        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        /* ç”¨æˆ·æ“ä½œæŒ‡ç¤ºå™¨ */
        .user-cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            background: #667eea;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>
                    <i class="material-icons">group_work</i>
                    å¤šç”¨æˆ·æµ‹è¯•
                </h1>
                <div class="user-info" id="userInfo">æœªç™»å½•</div>
            </div>

            <div class="sidebar-content">
                <div class="online-users">
                    <div class="section-title">
                        <i class="material-icons">people</i>
                        åœ¨çº¿ç”¨æˆ·
                    </div>
                    <div id="onlineUsersList">
                        <div class="user-item">
                            <div style="display: flex; align-items: center;">
                                <div class="user-avatar">A</div>
                                <div>
                                    <div style="font-weight: 500;">ç”¨æˆ·A</div>
                                    <div style="font-size: 12px; color: #666;">å½“å‰ç¼–è¾‘</div>
                                </div>
                            </div>
                            <div class="user-status"></div>
                        </div>
                    </div>
                </div>

                <div class="test-section">
                    <div class="section-title">
                        <i class="material-icons">settings</i>
                        æµ‹è¯•æ§åˆ¶
                    </div>
                    <button class="btn btn-primary" onclick="connectToDocument()" style="width: 100%; margin-bottom: 8px;">
                        <i class="material-icons">link</i>
                        è¿æ¥åˆ°æ–‡æ¡£
                    </button>
                    <button class="btn btn-secondary" onclick="disconnectFromDocument()" style="width: 100%; margin-bottom: 8px;">
                        <i class="material-icons">link_off</i>
                        æ–­å¼€è¿æ¥
                    </button>
                    <button class="btn btn-success" onclick="simulateTyping()" style="width: 100%; margin-bottom: 8px;">
                        <i class="material-icons">edit</i>
                        æ¨¡æ‹Ÿè¾“å…¥
                    </button>
                    <button class="btn btn-warning" onclick="sendTestOperation()" style="width: 100%; margin-bottom: 8px;">
                        <i class="material-icons">send</i>
                        å‘é€æµ‹è¯•æ“ä½œ
                    </button>
                    <button class="btn btn-danger" onclick="clearLog()" style="width: 100%;">
                        <i class="material-icons">clear</i>
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>

                <div class="test-section">
                    <div class="section-title">
                        <i class="material-icons">admin_panel_settings</i>
                        æƒé™ç®¡ç†
                    </div>
                    <div style="font-size: 12px; line-height: 1.5; color: #666;">
                        <p><strong>æˆ‘çš„æƒé™:</strong> <span id="myPermission">æœªæ£€æµ‹</span></p>
                        <button class="btn btn-secondary" onclick="checkMyPermission()" style="width: 100%; margin: 5px 0; font-size: 11px;">æ£€æµ‹æƒé™</button>
                        <button class="btn btn-primary" onclick="openPermissionModal()" style="width: 100%; margin: 5px 0; font-size: 11px;" id="managePermissionsBtn" style="display: none;">ç®¡ç†æƒé™</button>
                    </div>
                </div>

                <div class="test-section">
                    <div class="section-title">
                        <i class="material-icons">info</i>
                        æµ‹è¯•ä¿¡æ¯
                    </div>
                    <div style="font-size: 12px; line-height: 1.5; color: #666;">
                        <p><strong>æ–‡æ¡£ID:</strong> <span id="currentDocId">æœªè¿æ¥</span></p>
                        <p><strong>ç”¨æˆ·ID:</strong> <span id="currentUserId">æœªç™»å½•</span></p>
                        <p><strong>è¿æ¥çŠ¶æ€:</strong> <span class="connection-status disconnected" id="connectionStatus">æœªè¿æ¥</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="top-bar">
                <div class="document-info">
                    <i class="material-icons" style="cursor: pointer; margin-right: 16px;" onclick="toggleSidebar()">menu</i>
                    <div>
                        <div class="document-title">å¤šç”¨æˆ·åä½œæµ‹è¯•æ–‡æ¡£</div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            å®æ—¶åä½œç¼–è¾‘æµ‹è¯•ç¯å¢ƒ
                        </div>
                    </div>
                </div>
                <div class="collaborators">
                    <div class="collaborator-avatar" style="background: #667eea;">A</div>
                    <div class="collaborator-avatar" style="background: #28a745;">B</div>
                    <div class="collaborator-avatar" style="background: #ffc107;">C</div>
                </div>
            </div>

            <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
            <div class="editor-area">
                <div class="editor-container">
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="formatText('bold')">
                            <i class="material-icons">format_bold</i>
                        </button>
                        <button class="toolbar-btn" onclick="formatText('italic')">
                            <i class="material-icons">format_italic</i>
                        </button>
                        <button class="toolbar-btn" onclick="formatText('underline')">
                            <i class="material-icons">format_underlined</i>
                        </button>
                        <span style="margin-left: auto; color: #666; font-size: 12px;">
                            <i class="material-icons" style="font-size: 16px; vertical-align: middle;">group</i>
                            <span id="onlineCount">1</span>äººåœ¨çº¿
                        </span>
                    </div>
                    <div class="editor-content" contenteditable="true" id="editorContent">
                        æ¬¢è¿æ¥åˆ°å¤šç”¨æˆ·åœ¨çº¿ç¼–è¾‘æµ‹è¯•ç¯å¢ƒï¼

è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•å®æ—¶åä½œåŠŸèƒ½çš„æ–‡æ¡£ã€‚ä½ å¯ä»¥ï¼š

1. åœ¨å¤šä¸ªæµè§ˆå™¨çª—å£ä¸­æ‰“å¼€æ­¤é¡µé¢
2. åˆ†åˆ«ç™»å½•ä¸åŒçš„ç”¨æˆ·è´¦å·
3. ä½¿ç”¨"æ¨¡æ‹Ÿè¾“å…¥"æˆ–"å‘é€æµ‹è¯•æ“ä½œ"æŒ‰é’®è¿›è¡Œç¼–è¾‘
4. è§‚å¯Ÿå®æ—¶åŒæ­¥æ•ˆæœ

æ³¨æ„ï¼šå½“å‰ç‰ˆæœ¬ä½¿ç”¨æ‰‹åŠ¨æ“ä½œæŒ‰é’®ï¼Œé¿å…å¤æ‚çš„è‡ªåŠ¨diffç®—æ³•ã€‚

å¼€å§‹æµ‹è¯•å§ï¼ğŸš€

ç”¨æˆ·ID: <span id="editorUserId">æœªç™»å½•</span>
                    </div>
                </div>

                <!-- æ“ä½œæ—¥å¿— -->
                <div class="operation-log">
                    <div class="log-header">
                        <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">history</i>
                        æ“ä½œæ—¥å¿—
                    </div>
                    <div class="log-content" id="operationLog">
                        <div class="log-entry">ç³»ç»Ÿå·²å°±ç»ªï¼Œç­‰å¾…è¿æ¥...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="material-icons">person</i>
                    ç”¨æˆ·ç™»å½•
                </h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('loginModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                <button class="btn btn-outline" onclick="showRegisterModal()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="material-icons">person_add</i>
                    ç”¨æˆ·æ³¨å†Œ
                </h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" class="form-control" id="registerEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-control" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label class="form-label">æ˜µç§°</label>
                    <input type="text" class="form-control" id="registerNickname" placeholder="è¯·è¾“å…¥æ˜µç§°">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('registerModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- æ–‡æ¡£é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="documentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="material-icons">description</i>
                    é€‰æ‹©æµ‹è¯•æ–‡æ¡£
                </h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ–‡æ¡£ID</label>
                    <input type="number" class="form-control" id="documentIdInput" placeholder="è¾“å…¥æ–‡æ¡£IDè¿›è¡Œæµ‹è¯•" value="1">
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 8px;">
                    ğŸ’¡ æç¤ºï¼šå¯ä»¥è¾“å…¥åŒä¸€ä¸ªæ–‡æ¡£IDæ¥æµ‹è¯•å¤šç”¨æˆ·åä½œ
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('documentModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="connectToSelectedDocument()">è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- æƒé™ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="permissionModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="material-icons">admin_panel_settings</i>
                    æƒé™ç®¡ç†
                </h3>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #333;">æ–‡æ¡£æƒé™åˆ—è¡¨</h4>
                    <div id="permissionsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px;">
                        <div style="text-align: center; color: #666;">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <div style="border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #333;">æ·»åŠ ç”¨æˆ·æƒé™</h4>
                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·ID</label>
                        <input type="number" class="form-control" id="newUserId" placeholder="è¾“å…¥ç”¨æˆ·ID">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æƒé™ç±»å‹</label>
                        <select class="form-control" id="newPermissionType">
                            <option value="READ">åªè¯» (READ)</option>
                            <option value="WRITE">è¯»å†™ (WRITE)</option>
                            <option value="ADMIN">ç®¡ç†å‘˜ (ADMIN)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="addUserPermission()" style="width: 100%;">æ·»åŠ æƒé™</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('permissionModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let currentToken = localStorage.getItem('token') || '';
        let currentUserId = localStorage.getItem('userId') || '';
        let currentUser = null;
        let currentDocumentId = null;
        let stompClient = null;
        let isConnected = false;
        let lastContent = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthStatus();
            loadLibraries();
            showModal('loginModal'); // å¯åŠ¨æ—¶æ˜¾ç¤ºç™»å½•æ¡†
        });

        // åŠ è½½WebSocketåº“
        async function loadLibraries() {
            try {
                // åŠ è½½SockJS
                if (typeof SockJS === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js');
                    log('SockJSåº“åŠ è½½æˆåŠŸ');
                }

                // åŠ è½½STOMP
                if (typeof Stomp === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js');
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                log('æ‰€æœ‰WebSocketåº“åŠ è½½å®Œæˆ');
            } catch (error) {
                log('åº“åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error('åŠ è½½å¤±è´¥: ' + src));
                document.head.appendChild(script);

                setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶: ' + src)), 10000);
            });
        }

        // ç™»å½•ç›¸å…³å‡½æ•°
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const nickname = document.getElementById('registerNickname').value;

            try {
                const result = await apiRequest('/user/register', 'POST', {
                    username, email, password, nickname
                }, false);

                if (result.ok) {
                    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚');
                    hideModal('registerModal');
                    showModal('loginModal');
                } else {
                    alert('æ³¨å†Œå¤±è´¥ï¼š' + (result.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message);
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const result = await apiRequest('/user/login', 'POST', {
                    username, password
                }, false);

                if (result.ok && result.data.data) {
                    currentToken = result.data.data.token;
                    currentUserId = result.data.data.userId;
                    currentUser = result.data.data;

                    localStorage.setItem('token', currentToken);
                    localStorage.setItem('userId', currentUserId);
                    localStorage.setItem('user', JSON.stringify(currentUser));

                    updateAuthStatus();
                    hideModal('loginModal');

                    // ç™»å½•æˆåŠŸåæ˜¾ç¤ºæ–‡æ¡£é€‰æ‹©
                    setTimeout(() => {
                        showModal('documentModal');
                    }, 500);

                    log('ç”¨æˆ·ç™»å½•æˆåŠŸ: ' + currentUser.username, 'success');
                } else {
                    alert('ç™»å½•å¤±è´¥ï¼š' + (result.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }

        function showRegisterModal() {
            hideModal('loginModal');
            showModal('registerModal');
        }

        // æ›´æ–°è®¤è¯çŠ¶æ€
        function updateAuthStatus() {
            if (currentUser) {
                document.getElementById('userInfo').textContent = `ç”¨æˆ·: ${currentUser.nickname || currentUser.username}`;
                document.getElementById('currentUserId').textContent = currentUserId;
                document.getElementById('editorUserId').textContent = currentUserId;
            } else {
                document.getElementById('editorUserId').textContent = 'æœªç™»å½•';
            }
        }

        // APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, method = 'GET', body = null, needAuth = true) {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (needAuth && currentToken) {
                headers['Authorization'] = `Bearer ${currentToken}`;
            }
            const options = {
                method: method,
                headers: headers
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(`${API_BASE_URL}${url}`, options);
                const data = await response.json();
                return { ok: response.ok, data: data, status: response.status };
            } catch (error) {
                return { ok: false, data: { message: error.message }, status: 0 };
            }
        }

        // WebSocketè¿æ¥ç®¡ç†
        async function connectToDocument() {
            if (!currentUserId) {
                alert('è¯·å…ˆç™»å½•');
                showModal('loginModal');
                return;
            }

            showModal('documentModal');
        }

        async function connectToSelectedDocument() {
            const docId = document.getElementById('documentIdInput').value;
            if (!docId) {
                alert('è¯·è¾“å…¥æ–‡æ¡£ID');
                return;
            }

            currentDocumentId = parseInt(docId);
            document.getElementById('currentDocId').textContent = currentDocumentId;

            hideModal('documentModal');
            await establishWebSocketConnection();
        }

        async function establishWebSocketConnection() {
            if (!currentDocumentId || !currentUserId) {
                log('ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼Œæ— æ³•è¿æ¥', 'error');
                return;
            }

            try {
                updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');
                log('å¼€å§‹å»ºç«‹WebSocketè¿æ¥...');

                // æ–­å¼€ç°æœ‰è¿æ¥
                if (stompClient && stompClient.connected) {
                    stompClient.disconnect();
                }

                // åˆ›å»ºSockJSè¿æ¥ï¼Œåœ¨URLä¸­ä¼ é€’token
                const socket = new SockJS('http://localhost:8080/ws?token=' + encodeURIComponent(currentToken));

                // æ£€æŸ¥STOMPå¯¹è±¡
                let StompClient = Stomp || window.Stomp || window.stomp || window.STOMP;
                if (!StompClient) {
                    throw new Error('STOMPå¯¹è±¡æœªæ‰¾åˆ°');
                }

                stompClient = StompClient.over(socket);
                stompClient.debug = (str) => log('STOMP: ' + str, 'debug');

                // è¿æ¥åˆ°WebSocket
                stompClient.connect({}, function(frame) {
                    log('WebSocketè¿æ¥æˆåŠŸ! Frame: ' + frame, 'success');
                    updateConnectionStatus('connected', 'å·²è¿æ¥');
                    isConnected = true;

                    // è®¢é˜…æ–‡æ¡£é¢‘é“ï¼ˆåŒ…å«æ‰€æœ‰æ¶ˆæ¯ç±»å‹ï¼‰
                    const documentSubscription = stompClient.subscribe('/topic/document/' + currentDocumentId, function(message) {
                        const data = JSON.parse(message.body);
                        log('æ”¶åˆ°æ–‡æ¡£æ¶ˆæ¯: ' + data.type, 'success');

                        // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
                        switch (data.type) {
                            case 'OPERATION_APPLIED':
                                handleRemoteOperation(data);
                                break;
                            case 'CURSOR_MOVE':
                                handleCursorMove(data);
                                break;
                            case 'USER_JOINED':
                                handleUserJoined(data);
                                break;
                            case 'USER_LEFT':
                                handleUserLeft(data);
                                break;
                            case 'OFFLINE_SYNC_COMPLETE':
                                handleOfflineSyncComplete(data);
                                break;
                            default:
                                log('æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + data.type, 'warning');
                        }
                    });

                    // å‘é€åŠ å…¥æ–‡æ¡£æ¶ˆæ¯
                    sendJoinMessage();

                    // è·å–åˆå§‹åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                    setTimeout(() => {
                        updateOnlineUsersList();
                    }, 1000);

                    log('å·²è®¢é˜…æ‰€æœ‰å¿…è¦é¢‘é“', 'success');

                }, function(error) {
                    log('WebSocketè¿æ¥å¤±è´¥: ' + error, 'error');
                    updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                    isConnected = false;
                });

                // æ·»åŠ è¿æ¥æ–­å¼€å¤„ç†
                stompClient.onclose = function() {
                    log('WebSocketè¿æ¥å·²æ–­å¼€', 'warning');
                    updateConnectionStatus('disconnected', 'å·²æ–­å¼€');
                    isConnected = false;
                };

                stompClient.onerror = function(error) {
                    log('WebSocketå‘ç”Ÿé”™è¯¯: ' + error, 'error');
                };

            } catch (error) {
                log('å»ºç«‹è¿æ¥æ—¶å‡ºé”™: ' + error.message, 'error');
                updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                isConnected = false;
            }
        }

        function disconnectFromDocument() {
            if (stompClient && stompClient.connected) {
                // å‘é€ç¦»å¼€æ¶ˆæ¯
                sendLeaveMessage();
                stompClient.disconnect();
                log('å·²æ–­å¼€WebSocketè¿æ¥', 'success');
                updateConnectionStatus('disconnected', 'å·²æ–­å¼€');
                isConnected = false;
            } else {
                log('å½“å‰æœªè¿æ¥', 'error');
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendJoinMessage() {
            if (!stompClient || !stompClient.connected) return;

            const message = {
                userId: parseInt(currentUserId),
                documentId: currentDocumentId,
                type: 'JOIN',
                timestamp: Date.now()
            };

            stompClient.send('/app/document/join', {}, JSON.stringify(message));
            log('å‘é€åŠ å…¥æ–‡æ¡£æ¶ˆæ¯', 'success');
        }

        function sendLeaveMessage() {
            if (!stompClient || !stompClient.connected) return;

            const message = {
                userId: parseInt(currentUserId),
                documentId: currentDocumentId,
                type: 'LEAVE',
                timestamp: Date.now()
            };

            stompClient.send('/app/document/leave', {}, JSON.stringify(message));
            log('å‘é€ç¦»å¼€æ–‡æ¡£æ¶ˆæ¯', 'success');
        }

        function sendOperation(operation) {
            if (!stompClient || !stompClient.connected) {
                log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ“ä½œ', 'error');
                return;
            }

            const message = {
                userId: parseInt(currentUserId),
                documentId: currentDocumentId,
                type: 'OPERATION',
                data: operation,  // æ“ä½œæ•°æ®æ”¾åœ¨dataå­—æ®µä¸­
                timestamp: Date.now()
            };

            try {
                stompClient.send('/app/document/operation', {}, JSON.stringify(message));
                log('å‘é€æ“ä½œ: ' + JSON.stringify(operation), 'success');
            } catch (error) {
                log('å‘é€æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†è¿œç¨‹æ“ä½œ
        function handleRemoteOperation(data) {
            log('æ”¶åˆ°è¿œç¨‹æ“ä½œ: ' + JSON.stringify(data), 'success');

            // ä»å“åº”æ•°æ®ä¸­æå–å†…å®¹æ›´æ–°
            const responseData = data.data || {};
            if (responseData.content) {
                // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
                const editor = document.getElementById('editorContent');
                if (data.userId !== parseInt(currentUserId)) {
                    editor.textContent = responseData.content;
                    log('å†…å®¹å·²åŒæ­¥æ›´æ–°', 'success');
                }
            }
        }

        // å¤„ç†ç”¨æˆ·åŠ å…¥
        function handleUserJoined(data) {
            log('ç”¨æˆ·åŠ å…¥: ' + data.userId, 'success');
            // é‡æ–°è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            updateOnlineUsersList();
        }

        // å¤„ç†ç”¨æˆ·ç¦»å¼€
        function handleUserLeft(data) {
            log('ç”¨æˆ·ç¦»å¼€: ' + data.userId, 'success');
            // é‡æ–°è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            updateOnlineUsersList();
        }

        // å¤„ç†å…‰æ ‡ç§»åŠ¨
        function handleCursorMove(data) {
            log('å…‰æ ‡ç§»åŠ¨: ç”¨æˆ·' + data.userId + ' ä½ç½®' + (data.data?.position || 0), 'success');
            // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å…‰æ ‡æ˜¾ç¤º
        }

        // å¤„ç†ç¦»çº¿åŒæ­¥å®Œæˆ
        function handleOfflineSyncComplete(data) {
            log('ç¦»çº¿åŒæ­¥å®Œæˆ: ' + data.data?.syncedCount + 'ä¸ªæ“ä½œå·²åŒæ­¥', 'success');
        }

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        async function updateOnlineUsersList() {
            try {
                // è°ƒç”¨APIè·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                const result = await apiRequest('/collaboration/online/' + currentDocumentId, 'GET', null, true);
                if (result.ok && result.data.data) {
                    updateOnlineUsers(result.data.data);
                }
            } catch (error) {
                log('è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†ç”¨æˆ·çŠ¶æ€æ›´æ–°
        function handleUserStatusUpdate(data) {
            log('ç”¨æˆ·çŠ¶æ€æ›´æ–°: ' + JSON.stringify(data), 'success');

            // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            updateOnlineUsers(data.users || []);
        }

        // åº”ç”¨è¿œç¨‹æ“ä½œï¼ˆç®€åŒ–ç‰ˆï¼‰
        function applyRemoteOperation(operation) {
            const editor = document.getElementById('editorContent');
            let content = editor.textContent;

            if (operation.type === 'INSERT') {
                const position = Math.min(operation.position || 0, content.length);
                content = content.slice(0, position) + (operation.data || '') + content.slice(position);
            } else if (operation.type === 'DELETE') {
                const position = operation.position || 0;
                const length = operation.length || 1;
                content = content.slice(0, position) + content.slice(position + length);
            }

            editor.textContent = content;
            log('å·²åº”ç”¨è¿œç¨‹æ“ä½œ', 'success');
        }

        // å¤„ç†æœ¬åœ°å†…å®¹å˜åŒ– - ç®€åŒ–ä¸ºæ‰‹åŠ¨è§¦å‘
        function handleContentChange() {
            // å½“å‰ç‰ˆæœ¬æš‚æ—¶ç¦ç”¨è‡ªåŠ¨å†…å®¹å˜åŒ–æ£€æµ‹
            // ç”¨æˆ·å¯ä»¥é€šè¿‡"æ¨¡æ‹Ÿè¾“å…¥"æŒ‰é’®æ‰‹åŠ¨å‘é€æ“ä½œ
            // æˆ–è€…ç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥ï¼Œç„¶åç‚¹å‡»"å‘é€æµ‹è¯•æ“ä½œ"æŒ‰é’®
        }

        // æ£€æµ‹å†…å®¹å˜åŒ–ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function detectContentChanges(oldContent, newContent) {
            const changes = [];

            if (newContent.length > oldContent.length) {
                // æ’å…¥æ“ä½œ
                const insertPos = findDifferencePosition(oldContent, newContent);
                const insertData = newContent.slice(insertPos, insertPos + (newContent.length - oldContent.length));
                changes.push({
                    type: 'INSERT',
                    data: insertData,
                    position: insertPos
                });
            } else if (newContent.length < oldContent.length) {
                // åˆ é™¤æ“ä½œ
                const deletePos = findDifferencePosition(oldContent, newContent);
                const deleteLength = oldContent.length - newContent.length;
                changes.push({
                    type: 'DELETE',
                    position: deletePos,
                    length: deleteLength
                });
            }

            return changes;
        }

        // æŸ¥æ‰¾å·®å¼‚ä½ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function findDifferencePosition(str1, str2) {
            const minLength = Math.min(str1.length, str2.length);
            for (let i = 0; i < minLength; i++) {
                if (str1[i] !== str2[i]) {
                    return i;
                }
            }
            return minLength;
        }

        // æ¨¡æ‹Ÿè¾“å…¥ - ç®€åŒ–ä¸ºç®€å•çš„æ’å…¥æ“ä½œ
        function simulateTyping() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æ–‡æ¡£', 'error');
                return;
            }

            // å‘é€ä¸€ä¸ªç®€å•çš„æ’å…¥æ“ä½œ
            const operation = {
                type: 'INSERT',
                data: ' [ç”¨æˆ·' + currentUserId + 'è¾“å…¥]',
                position: document.getElementById('editorContent').textContent.length
            };

            sendOperation(operation);
            log('å‘é€æ¨¡æ‹Ÿè¾“å…¥æ“ä½œ', 'success');
        }

        // å‘é€æµ‹è¯•æ“ä½œ
        function sendTestOperation() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æ–‡æ¡£', 'error');
                return;
            }

            // å‘é€ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ’å…¥æ“ä½œ
            const operation = {
                type: 'INSERT',
                data: ' [æµ‹è¯•æ“ä½œ - ç”¨æˆ·' + currentUserId + ']',
                position: Math.floor(Math.random() * 50) // éšæœºä½ç½®ï¼Œé¿å…å†²çª
            };

            sendOperation(operation);
            log('å‘é€æµ‹è¯•æ“ä½œ: ' + JSON.stringify(operation), 'success');
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'connection-status ' + status;
            statusEl.textContent = message || status;
        }

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·
        function updateOnlineUsers(users) {
            const count = users.length || 1;
            document.getElementById('onlineCount').textContent = count;

            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
            const userList = document.getElementById('onlineUsersList');
            userList.innerHTML = users.map((user, index) => `
                <div class="user-item">
                    <div style="display: flex; align-items: center;">
                        <div class="user-avatar">${String.fromCharCode(65 + index)}</div>
                        <div>
                            <div style="font-weight: 500;">ç”¨æˆ·${user.userId}</div>
                            <div style="font-size: 12px; color: #666;">${user.status || 'åœ¨çº¿'}</div>
                        </div>
                    </div>
                    <div class="user-status"></div>
                </div>
            `).join('') || `
                <div class="user-item">
                    <div style="display: flex; align-items: center;">
                        <div class="user-avatar">A</div>
                        <div>
                            <div style="font-weight: 500;">å½“å‰ç”¨æˆ·</div>
                            <div style="font-size: 12px; color: #666;">åœ¨çº¿</div>
                        </div>
                    </div>
                    <div class="user-status"></div>
                </div>
            `;
        }

        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logContent = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('operationLog').innerHTML = '';
        }

        // æ¨¡æ€æ¡†ç®¡ç†
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        // æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆæ¨¡æ‹Ÿï¼‰
        function formatText(format) {
            log('æ–‡æœ¬æ ¼å¼åŒ–åŠŸèƒ½: ' + format, 'success');
            // è¿™é‡Œå¯ä»¥å®ç°å®é™…çš„æ–‡æœ¬æ ¼å¼åŒ–
        }

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (stompClient && stompClient.connected) {
                sendLeaveMessage();
                stompClient.disconnect();
            }
        });

        // æƒé™ç®¡ç†ç›¸å…³å‡½æ•°
        async function checkMyPermission() {
            if (!currentUserId || !currentDocumentId) {
                log('è¯·å…ˆç™»å½•å¹¶è¿æ¥åˆ°æ–‡æ¡£', 'error');
                return;
            }

            try {
                const result = await apiRequest('/permissions/check?documentId=' + currentDocumentId + '&userId=' + currentUserId + '&permissionType=ADMIN', 'GET', null, true);

                if (result.ok && result.data.data) {
                    const hasAdmin = result.data.data.hasPermission;
                    document.getElementById('myPermission').textContent = hasAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';

                    // æ˜¾ç¤ºæˆ–éšè—ç®¡ç†æƒé™æŒ‰é’®
                    document.getElementById('managePermissionsBtn').style.display = hasAdmin ? 'block' : 'none';

                    log('æƒé™æ£€æµ‹å®Œæˆ: ' + (hasAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'), 'success');
                } else {
                    document.getElementById('myPermission').textContent = 'æ£€æµ‹å¤±è´¥';
                    log('æƒé™æ£€æµ‹å¤±è´¥: ' + (result.data?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                document.getElementById('myPermission').textContent = 'æ£€æµ‹å¤±è´¥';
                log('æƒé™æ£€æµ‹å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        function openPermissionModal() {
            if (!currentDocumentId) {
                log('è¯·å…ˆè¿æ¥åˆ°æ–‡æ¡£', 'error');
                return;
            }

            showModal('permissionModal');
            loadPermissionsList();
        }

        async function loadPermissionsList() {
            const permissionsList = document.getElementById('permissionsList');

            try {
                permissionsList.innerHTML = '<div style="text-align: center; color: #666;">åŠ è½½ä¸­...</div>';

                const result = await apiRequest('/permissions/document/' + currentDocumentId, 'GET', null, true);

                if (result.ok && result.data.data) {
                    const permissions = result.data.data;

                    if (permissions.length === 0) {
                        permissionsList.innerHTML = '<div style="text-align: center; color: #666;">æš‚æ— æƒé™è®¾ç½®</div>';
                        return;
                    }

                    let html = '';
                    permissions.forEach(permission => {
                        const permissionText = getPermissionText(permission.permissionType);
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <div>
                                    <strong>ç”¨æˆ· ${permission.userId}</strong>
                                    <span style="color: #666; margin-left: 10px;">${permissionText}</span>
                                </div>
                                <div>
                                    <select onchange="changeUserPermission(${permission.userId}, this.value)" style="font-size: 12px; padding: 2px 4px;">
                                        <option value="READ" ${permission.permissionType === 'READ' ? 'selected' : ''}>åªè¯»</option>
                                        <option value="WRITE" ${permission.permissionType === 'WRITE' ? 'selected' : ''}>è¯»å†™</option>
                                        <option value="ADMIN" ${permission.permissionType === 'ADMIN' ? 'selected' : ''}>ç®¡ç†å‘˜</option>
                                    </select>
                                    <button onclick="removeUserPermission(${permission.userId})" style="margin-left: 5px; font-size: 12px; padding: 2px 6px;" class="btn btn-danger">åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                    });

                    permissionsList.innerHTML = html;
                } else {
                    permissionsList.innerHTML = '<div style="text-align: center; color: #f00;">åŠ è½½å¤±è´¥: ' + (result.data?.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                permissionsList.innerHTML = '<div style="text-align: center; color: #f00;">åŠ è½½å¼‚å¸¸: ' + error.message + '</div>';
            }
        }

        async function addUserPermission() {
            const userId = document.getElementById('newUserId').value;
            const permissionType = document.getElementById('newPermissionType').value;

            if (!userId || !permissionType) {
                alert('è¯·è¾“å…¥ç”¨æˆ·IDå’Œæƒé™ç±»å‹');
                return;
            }

            try {
                const result = await apiRequest('/permissions', 'POST', {
                    documentId: currentDocumentId,
                    userId: parseInt(userId),
                    permissionType: permissionType
                }, true);

                if (result.ok) {
                    log('æƒé™æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('newUserId').value = '';
                    loadPermissionsList(); // é‡æ–°åŠ è½½æƒé™åˆ—è¡¨
                } else {
                    log('æƒé™æ·»åŠ å¤±è´¥: ' + (result.data?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                log('æƒé™æ·»åŠ å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        async function changeUserPermission(userId, newPermissionType) {
            try {
                const result = await apiRequest('/permissions', 'PUT', {
                    documentId: currentDocumentId,
                    userId: parseInt(userId),
                    permissionType: newPermissionType
                }, true);

                if (result.ok) {
                    log('æƒé™ä¿®æ”¹æˆåŠŸ', 'success');
                } else {
                    log('æƒé™ä¿®æ”¹å¤±è´¥: ' + (result.data?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    loadPermissionsList(); // é‡æ–°åŠ è½½ä»¥æ¢å¤åŸå€¼
                }
            } catch (error) {
                log('æƒé™ä¿®æ”¹å¼‚å¸¸: ' + error.message, 'error');
                loadPermissionsList(); // é‡æ–°åŠ è½½ä»¥æ¢å¤åŸå€¼
            }
        }

        async function removeUserPermission(userId) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥ç”¨æˆ·çš„æƒé™å—ï¼Ÿ')) {
                return;
            }

            try {
                const result = await apiRequest('/permissions?documentId=' + currentDocumentId + '&userId=' + userId, 'DELETE', null, true);

                if (result.ok) {
                    log('æƒé™ç§»é™¤æˆåŠŸ', 'success');
                    loadPermissionsList(); // é‡æ–°åŠ è½½æƒé™åˆ—è¡¨
                } else {
                    log('æƒé™ç§»é™¤å¤±è´¥: ' + (result.data?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                log('æƒé™ç§»é™¤å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        function getPermissionText(permissionType) {
            switch (permissionType) {
                case 'READ': return 'åªè¯»';
                case 'WRITE': return 'è¯»å†™';
                case 'ADMIN': return 'ç®¡ç†å‘˜';
                default: return 'æœªçŸ¥';
            }
        }

        // åˆå§‹åŒ–æœ€åå†…å®¹
        setTimeout(() => {
            lastContent = document.getElementById('editorContent').textContent;
        }, 1000);
    </script>
</body>
</html>
