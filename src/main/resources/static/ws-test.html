<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè¿æ¥æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.pending { background: #fff3cd; color: #856404; }
        .status.running { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
        }

        .result.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-area {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 2px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .connection-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .connection-info h4 {
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .connection-info p {
            color: #666;
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ WebSocketè¿æ¥æµ‹è¯•</h1>
            <p>æµ‹è¯•å®æ—¶é€šä¿¡åŠŸèƒ½</p>
        </div>

        <div class="content">
            <div class="connection-info">
                <h4>ğŸ“¡ è¿æ¥ä¿¡æ¯</h4>
                <p><strong>ç«¯ç‚¹ï¼š</strong> http://localhost:8080/ws</p>
                <p><strong>åè®®ï¼š</strong> STOMP over SockJS</p>
                <p><strong>çŠ¶æ€ï¼š</strong> <span id="connectionStatus">æœªè¿æ¥</span></p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('basic')">åŸºç¡€è¿æ¥æµ‹è¯•</button>
                <button class="tab" onclick="switchTab('advanced')">é«˜çº§åŠŸèƒ½æµ‹è¯•</button>
                <button class="tab" onclick="switchTab('realtime')">å®æ—¶åä½œæµ‹è¯•</button>
            </div>

            <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
            <div id="tab-basic" class="tab-content active">
                <div class="test-section">
                    <div class="test-header">
                        <h3 class="test-title">ğŸ”Œ åŸºç¡€è¿æ¥æµ‹è¯•</h3>
                        <span class="status pending" id="basicStatus">å¾…æµ‹è¯•</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="testBasicConnection()">æµ‹è¯•è¿æ¥</button>
                        <button class="btn btn-secondary" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div class="result info" id="basicResult">ç‚¹å‡»"æµ‹è¯•è¿æ¥"å¼€å§‹æµ‹è¯•WebSocketè¿æ¥</div>
                </div>

                <div class="test-section">
                    <div class="test-header">
                        <h3 class="test-title">ğŸ“ è¿æ¥æ—¥å¿—</h3>
                    </div>
                    <div class="log-area" id="logArea"></div>
                </div>
            </div>

            <!-- é«˜çº§åŠŸèƒ½æµ‹è¯• -->
            <div id="tab-advanced" class="tab-content">
                <div class="test-section">
                    <div class="test-header">
                        <h3 class="test-title">ğŸ”§ è®¢é˜…æµ‹è¯•</h3>
                        <span class="status pending" id="subscribeStatus">å¾…æµ‹è¯•</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è®¢é˜…é¢‘é“</label>
                        <input type="text" class="form-control" id="subscribeTopic" placeholder="/topic/test" value="/topic/test">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="testSubscription()">è®¢é˜…é¢‘é“</button>
                        <button class="btn btn-danger" onclick="unsubscribeTopic()">å–æ¶ˆè®¢é˜…</button>
                    </div>
                    <div class="result info" id="subscribeResult">æµ‹è¯•é¢‘é“è®¢é˜…åŠŸèƒ½</div>
                </div>

                <div class="test-section">
                    <div class="test-header">
                        <h3 class="test-title">ğŸ“¤ å‘é€æ¶ˆæ¯æµ‹è¯•</h3>
                        <span class="status pending" id="sendStatus">å¾…æµ‹è¯•</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡åœ°å€</label>
                        <input type="text" class="form-control" id="sendDestination" placeholder="/app/test" value="/app/test">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¶ˆæ¯å†…å®¹</label>
                        <textarea class="form-control" id="sendMessage" rows="3" placeholder='{"message": "Hello WebSocket!"}'>{"message": "Hello WebSocket!", "timestamp": "' + new Date().toISOString() + '"}</textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
                    </div>
                    <div class="result info" id="sendResult">æµ‹è¯•æ¶ˆæ¯å‘é€åŠŸèƒ½</div>
                </div>
            </div>

            <!-- å®æ—¶åä½œæµ‹è¯• -->
            <div id="tab-realtime" class="tab-content">
                <div class="test-section">
                    <div class="test-header">
                        <h3 class="test-title">ğŸ‘¥ æ–‡æ¡£åä½œæ¨¡æ‹Ÿ</h3>
                        <span class="status pending" id="collabStatus">å¾…æµ‹è¯•</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡æ‹Ÿç”¨æˆ·ID</label>
                        <input type="number" class="form-control" id="userId" placeholder="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡æ¡£ID</label>
                        <input type="number" class="form-control" id="documentId" placeholder="1" value="1">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="simulateJoin()">æ¨¡æ‹ŸåŠ å…¥æ–‡æ¡£</button>
                        <button class="btn btn-success" onclick="simulateOperation()">æ¨¡æ‹Ÿæ“ä½œ</button>
                        <button class="btn btn-secondary" onclick="simulateLeave()">æ¨¡æ‹Ÿç¦»å¼€æ–‡æ¡£</button>
                    </div>
                    <div class="result info" id="collabResult">æ¨¡æ‹Ÿå¤šäººåä½œåœºæ™¯</div>
                </div>

                <div class="test-section">
                    <div class="test-header">
                        <h3 class="test-title">ğŸ“Š åä½œçŠ¶æ€</h3>
                    </div>
                    <div class="result info" id="collabStatusResult">åä½œçŠ¶æ€ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let subscriptions = new Map();
        let connectionStatus = 'disconnected';

        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logArea.textContent += logEntry;
            logArea.scrollTop = logArea.scrollHeight;

            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, message = '') {
            connectionStatus = status;
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message || status;

            // æ›´æ–°çŠ¶æ€é¢œè‰²
            statusEl.style.color = status === 'connected' ? '#28a745' :
                                  status === 'connecting' ? '#ffc107' :
                                  status === 'disconnected' ? '#dc3545' : '#6c757d';
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // åŸºç¡€è¿æ¥æµ‹è¯•
        function testBasicConnection() {
            setTestStatus('basicStatus', 'running');
            updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');
            log('å¼€å§‹WebSocketè¿æ¥æµ‹è¯•...');

            try {
                // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆæ–­å¼€
                if (stompClient && stompClient.connected) {
                    stompClient.disconnect();
                    log('æ–­å¼€ç°æœ‰è¿æ¥');
                }

                // åˆ›å»ºSockJSè¿æ¥
                const socket = new SockJS('http://localhost:8080/ws');
                // æ£€æŸ¥STOMPå¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œå¯èƒ½ä½¿ç”¨ä¸åŒçš„å˜é‡å
                let StompClient = Stomp || window.Stomp;
                if (!StompClient) {
                    // å°è¯•å…¶ä»–å¯èƒ½çš„å…¨å±€å˜é‡å
                    StompClient = window.stomp || window.STOMP;
                }
                if (!StompClient) {
                    throw new Error('STOMPå¯¹è±¡æœªæ‰¾åˆ°ï¼Œå¯èƒ½åº“åŠ è½½å¤±è´¥æˆ–ä½¿ç”¨ä¸åŒå˜é‡å');
                }
                stompClient = StompClient.over(socket);

                // é…ç½® - ç®€åŒ–é…ç½®ä»¥æé«˜å…¼å®¹æ€§
                stompClient.debug = (str) => log('STOMP: ' + str, 'debug');

                log('æ­£åœ¨è¿æ¥åˆ°WebSocketæœåŠ¡å™¨...');

                // è¿æ¥ - ä½¿ç”¨ç®€åŒ–å‚æ•°
                stompClient.connect({}, function(frame) {
                    log('WebSocketè¿æ¥æˆåŠŸ!');
                    log('è¿æ¥æ¡†æ¶: ' + frame);
                    updateConnectionStatus('connected', 'å·²è¿æ¥');

                    // è®¢é˜…æµ‹è¯•é¢‘é“
                    const subscription = stompClient.subscribe('/topic/test', function(message) {
                        log('æ”¶åˆ°æ¶ˆæ¯: ' + message.body, 'success');
                    });
                    subscriptions.set('/topic/test', subscription);
                    log('å·²è®¢é˜… /topic/test é¢‘é“');

                    setTestStatus('basicStatus', 'success');
                    setTestResult('basicResult', 'âœ… WebSocketè¿æ¥æµ‹è¯•é€šè¿‡!\n\nè¿æ¥çŠ¶æ€: å·²è¿æ¥\nåè®®: STOMP over SockJS\nå¿ƒè·³: 10ç§’\nè®¢é˜…é¢‘é“: /topic/test', 'success');

                }, function(error) {
                    log('WebSocketè¿æ¥å¤±è´¥: ' + error, 'error');
                    updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                    setTestStatus('basicStatus', 'error');
                    setTestResult('basicResult', 'âŒ WebSocketè¿æ¥å¤±è´¥!\n\né”™è¯¯ä¿¡æ¯: ' + error + '\n\nå¯èƒ½çš„åŸå› :\n1. WebSocketæœåŠ¡æœªå¯åŠ¨\n2. ç«¯å£8080è¢«å ç”¨\n3. é˜²ç«å¢™é˜»æ­¢è¿æ¥\n4. SockJSåº“åŠ è½½å¤±è´¥', 'error');
                });

            } catch (error) {
                log('è¿æ¥æµ‹è¯•å¼‚å¸¸: ' + error.message, 'error');
                setTestStatus('basicStatus', 'error');
                setTestResult('basicResult', 'âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: ' + error.message, 'error');
                updateConnectionStatus('disconnected', 'å¼‚å¸¸');
            }
        }

        // æµ‹è¯•è®¢é˜…
        function testSubscription() {
            if (!stompClient || !stompClient.connected) {
                setTestResult('subscribeResult', 'âŒ è¯·å…ˆå»ºç«‹WebSocketè¿æ¥', 'error');
                return;
            }

            setTestStatus('subscribeStatus', 'running');

            const topic = document.getElementById('subscribeTopic').value;
            if (!topic) {
                setTestResult('subscribeResult', 'âŒ è¯·è¾“å…¥è®¢é˜…é¢‘é“', 'error');
                return;
            }

            try {
                // å¦‚æœå·²è®¢é˜…ï¼Œå…ˆå–æ¶ˆ
                if (subscriptions.has(topic)) {
                    subscriptions.get(topic).unsubscribe();
                    subscriptions.delete(topic);
                    log('å–æ¶ˆè®¢é˜…: ' + topic);
                }

                // è®¢é˜…æ–°é¢‘é“
                const subscription = stompClient.subscribe(topic, function(message) {
                    log('è®¢é˜…æ¶ˆæ¯ [' + topic + ']: ' + message.body, 'success');
                });

                subscriptions.set(topic, subscription);
                log('æˆåŠŸè®¢é˜…é¢‘é“: ' + topic);

                setTestStatus('subscribeStatus', 'success');
                setTestResult('subscribeResult', 'âœ… é¢‘é“è®¢é˜…æˆåŠŸ!\n\nè®¢é˜…é¢‘é“: ' + topic + '\nçŠ¶æ€: æ´»è·ƒ', 'success');

            } catch (error) {
                log('è®¢é˜…å¤±è´¥: ' + error.message, 'error');
                setTestStatus('subscribeStatus', 'error');
                setTestResult('subscribeResult', 'âŒ è®¢é˜…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆè®¢é˜…
        function unsubscribeTopic() {
            const topic = document.getElementById('subscribeTopic').value;
            if (subscriptions.has(topic)) {
                subscriptions.get(topic).unsubscribe();
                subscriptions.delete(topic);
                log('å·²å–æ¶ˆè®¢é˜…: ' + topic);
                setTestResult('subscribeResult', 'âœ… å·²å–æ¶ˆè®¢é˜…: ' + topic, 'info');
            } else {
                setTestResult('subscribeResult', 'âŒ æœªè®¢é˜…è¯¥é¢‘é“: ' + topic, 'error');
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!stompClient || !stompClient.connected) {
                setTestResult('sendResult', 'âŒ è¯·å…ˆå»ºç«‹WebSocketè¿æ¥', 'error');
                return;
            }

            setTestStatus('sendStatus', 'running');

            const destination = document.getElementById('sendDestination').value;
            const messageContent = document.getElementById('sendMessage').value;

            if (!destination || !messageContent) {
                setTestResult('sendResult', 'âŒ è¯·è¾“å…¥ç›®æ ‡åœ°å€å’Œæ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            try {
                stompClient.send(destination, {}, messageContent);
                log('å‘é€æ¶ˆæ¯åˆ° ' + destination + ': ' + messageContent);

                setTestStatus('sendStatus', 'success');
                setTestResult('sendResult', 'âœ… æ¶ˆæ¯å‘é€æˆåŠŸ!\n\nç›®æ ‡: ' + destination + '\nå†…å®¹: ' + messageContent, 'success');

            } catch (error) {
                log('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
                setTestStatus('sendStatus', 'error');
                setTestResult('sendResult', 'âŒ å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¨¡æ‹ŸåŠ å…¥æ–‡æ¡£
        function simulateJoin() {
            if (!stompClient || !stompClient.connected) {
                setTestResult('collabResult', 'âŒ è¯·å…ˆå»ºç«‹WebSocketè¿æ¥', 'error');
                return;
            }

            const userId = document.getElementById('userId').value;
            const documentId = document.getElementById('documentId').value;

            if (!userId || !documentId) {
                setTestResult('collabResult', 'âŒ è¯·è¾“å…¥ç”¨æˆ·IDå’Œæ–‡æ¡£ID', 'error');
                return;
            }

            const message = {
                userId: parseInt(userId),
                documentId: parseInt(documentId),
                type: 'JOIN'
            };

            try {
                stompClient.send('/app/document/join', {}, JSON.stringify(message));
                log('æ¨¡æ‹Ÿç”¨æˆ·åŠ å…¥æ–‡æ¡£: ç”¨æˆ·' + userId + ' åŠ å…¥æ–‡æ¡£' + documentId);

                setTestResult('collabResult', 'âœ… æ¨¡æ‹ŸåŠ å…¥æ–‡æ¡£æˆåŠŸ!\n\nç”¨æˆ·ID: ' + userId + '\næ–‡æ¡£ID: ' + documentId + '\næ“ä½œ: åŠ å…¥æ–‡æ¡£', 'success');
                setTestStatus('collabStatus', 'success');

            } catch (error) {
                log('æ¨¡æ‹ŸåŠ å…¥å¤±è´¥: ' + error.message, 'error');
                setTestResult('collabResult', 'âŒ æ¨¡æ‹ŸåŠ å…¥å¤±è´¥: ' + error.message, 'error');
                setTestStatus('collabStatus', 'error');
            }
        }

        // æ¨¡æ‹Ÿæ“ä½œ
        function simulateOperation() {
            if (!stompClient || !stompClient.connected) {
                setTestResult('collabResult', 'âŒ è¯·å…ˆå»ºç«‹WebSocketè¿æ¥', 'error');
                return;
            }

            const userId = document.getElementById('userId').value;
            const documentId = document.getElementById('documentId').value;

            if (!userId || !documentId) {
                setTestResult('collabResult', 'âŒ è¯·è¾“å…¥ç”¨æˆ·IDå’Œæ–‡æ¡£ID', 'error');
                return;
            }

            const message = {
                userId: parseInt(userId),
                documentId: parseInt(documentId),
                type: 'OPERATION',
                operation: {
                    type: 'INSERT',
                    data: 'å®æ—¶åä½œæµ‹è¯•æ–‡æœ¬',
                    position: 0,
                    length: 8
                }
            };

            try {
                stompClient.send('/app/document/operation', {}, JSON.stringify(message));
                log('æ¨¡æ‹Ÿæ–‡æ¡£æ“ä½œ: ç”¨æˆ·' + userId + ' åœ¨æ–‡æ¡£' + documentId + 'ä¸­æ’å…¥æ–‡æœ¬');

                setTestResult('collabResult', 'âœ… æ¨¡æ‹Ÿæ“ä½œæˆåŠŸ!\n\nç”¨æˆ·ID: ' + userId + '\næ–‡æ¡£ID: ' + documentId + '\næ“ä½œ: æ’å…¥æ–‡æœ¬ "å®æ—¶åä½œæµ‹è¯•æ–‡æœ¬"', 'success');

            } catch (error) {
                log('æ¨¡æ‹Ÿæ“ä½œå¤±è´¥: ' + error.message, 'error');
                setTestResult('collabResult', 'âŒ æ¨¡æ‹Ÿæ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¨¡æ‹Ÿç¦»å¼€æ–‡æ¡£
        function simulateLeave() {
            if (!stompClient || !stompClient.connected) {
                setTestResult('collabResult', 'âŒ è¯·å…ˆå»ºç«‹WebSocketè¿æ¥', 'error');
                return;
            }

            const userId = document.getElementById('userId').value;
            const documentId = document.getElementById('documentId').value;

            if (!userId || !documentId) {
                setTestResult('collabResult', 'âŒ è¯·è¾“å…¥ç”¨æˆ·IDå’Œæ–‡æ¡£ID', 'error');
                return;
            }

            const message = {
                userId: parseInt(userId),
                documentId: parseInt(documentId),
                type: 'LEAVE'
            };

            try {
                stompClient.send('/app/document/leave', {}, JSON.stringify(message));
                log('æ¨¡æ‹Ÿç”¨æˆ·ç¦»å¼€æ–‡æ¡£: ç”¨æˆ·' + userId + ' ç¦»å¼€æ–‡æ¡£' + documentId);

                setTestResult('collabResult', 'âœ… æ¨¡æ‹Ÿç¦»å¼€æ–‡æ¡£æˆåŠŸ!\n\nç”¨æˆ·ID: ' + userId + '\næ–‡æ¡£ID: ' + documentId + '\næ“ä½œ: ç¦»å¼€æ–‡æ¡£', 'success');

            } catch (error) {
                log('æ¨¡æ‹Ÿç¦»å¼€å¤±è´¥: ' + error.message, 'error');
                setTestResult('collabResult', 'âŒ æ¨¡æ‹Ÿç¦»å¼€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function setTestStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status ' + status;
            element.textContent = status === 'running' ? 'æµ‹è¯•ä¸­...' :
                                status === 'success' ? 'âœ… é€šè¿‡' :
                                status === 'error' ? 'âŒ å¤±è´¥' : 'å¾…æµ‹è¯•';
        }

        function setTestResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = 'result ' + type;
            element.textContent = message;
        }

        function clearLog() {
            document.getElementById('logArea').textContent = '';
        }

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect();
            }
        });

        // åŠ è½½å¿…è¦çš„åº“
        async function loadLibraries() {
            log('å¼€å§‹åŠ è½½WebSocketåº“...');

            try {
                // åŠ è½½SockJS
                if (typeof SockJS === 'undefined') {
                    log('åŠ è½½SockJSåº“...');
                    await loadScript('https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js');
                    log('SockJSåº“åŠ è½½æˆåŠŸ');
                } else {
                    log('SockJSåº“å·²å­˜åœ¨');
                }

                // åŠ è½½STOMP - ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
                if (typeof Stomp === 'undefined') {
                    log('åŠ è½½STOMPåº“...');
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js');
                    log('STOMPåº“åŠ è½½æˆåŠŸ');
                    // ç­‰å¾…åº“åˆå§‹åŒ–
                    await new Promise(resolve => setTimeout(resolve, 200));
                    // æ£€æŸ¥æ˜¯å¦çœŸçš„åŠ è½½æˆåŠŸ
                    if (typeof Stomp === 'undefined') {
                        throw new Error('STOMPåº“åŠ è½½å¤±è´¥ï¼Œå…¨å±€å˜é‡æœªå®šä¹‰');
                    }
                } else {
                    log('STOMPåº“å·²å­˜åœ¨');
                }

                log('æ‰€æœ‰åº“åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
                updateLibraryStatus();

            } catch (error) {
                log('åº“åŠ è½½å¤±è´¥: ' + error.message, 'error');
                log('å°è¯•å¤‡ç”¨åŠ è½½æ–¹å¼...', 'warning');

                // å¤‡ç”¨åŠ è½½æ–¹å¼
                try {
                    await loadBackupLibraries();
                } catch (backupError) {
                    log('å¤‡ç”¨åŠ è½½ä¹Ÿå¤±è´¥: ' + backupError.message, 'error');
                }
            }
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error('åŠ è½½å¤±è´¥: ' + src));
                document.head.appendChild(script);

                // è¶…æ—¶å¤„ç†
                setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶: ' + src)), 10000);
            });
        }

        // å¤‡ç”¨åº“åŠ è½½æ–¹å¼
        async function loadBackupLibraries() {
            log('ä½¿ç”¨å¤‡ç”¨CDNåŠ è½½åº“...');

            // å¤‡ç”¨SockJS
            if (typeof SockJS === 'undefined') {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js');
                log('SockJSåº“(å¤‡ç”¨)åŠ è½½æˆåŠŸ');
            }

            // å¤‡ç”¨STOMP - ä½¿ç”¨SockJSå…¼å®¹ç‰ˆæœ¬
            if (typeof Stomp === 'undefined') {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js');
                log('STOMPåº“(å¤‡ç”¨)åŠ è½½æˆåŠŸ');
                // ç­‰å¾…åº“åˆå§‹åŒ–
                await new Promise(resolve => setTimeout(resolve, 200));
                // æ£€æŸ¥æ˜¯å¦çœŸçš„åŠ è½½æˆåŠŸ
                if (typeof Stomp === 'undefined') {
                    throw new Error('STOMPå¤‡ç”¨åº“åŠ è½½å¤±è´¥');
                }
            }
        }

        // æ›´æ–°åº“çŠ¶æ€æ˜¾ç¤º
        function updateLibraryStatus() {
            const status = document.getElementById('connectionStatus');
            const sockjsLoaded = typeof SockJS !== 'undefined';
            const stompLoaded = typeof Stomp !== 'undefined';

            if (sockjsLoaded && stompLoaded) {
                status.textContent = 'åº“å·²åŠ è½½ - å¯æµ‹è¯•';
                status.style.color = '#28a745';
            } else {
                status.textContent = `åº“åŠ è½½ä¸­ - SockJS: ${sockjsLoaded ? 'âœ“' : 'âœ—'}, STOMP: ${stompLoaded ? 'âœ“' : 'âœ—'}`;
                status.style.color = '#ffc107';
            }
        }

        // åˆå§‹åŒ–æ—¥å¿—
        log('WebSocketæµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('å‡†å¤‡åŠ è½½WebSocketåº“...');

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åŠ è½½åº“
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadLibraries);
        } else {
            loadLibraries();
        }
    </script>
</body>
</html>
