<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .test-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .result.success { background: #d4edda; color: #155724; }
        .result.error { background: #f8d7da; color: #721c24; }
        .result.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š WebSocketåº“åŠ è½½æµ‹è¯•</h1>
            <p>è¯Šæ–­SockJSå’ŒSTOMPåº“åŠ è½½çŠ¶æ€</p>
        </div>

        <div class="test-section">
            <div class="test-header">
                <h3 class="test-title">ğŸ” å½“å‰åº“çŠ¶æ€</h3>
            </div>
            <div id="currentStatus" class="result info">æ­£åœ¨æ£€æŸ¥åº“çŠ¶æ€...</div>
            <button class="btn btn-primary" onclick="checkLibraries()">é‡æ–°æ£€æŸ¥</button>
        </div>

        <div class="test-section">
            <div class="test-header">
                <h3 class="test-title">ğŸ“¥ SockJSåº“æµ‹è¯•</h3>
                <span class="status" id="sockjsStatus">å¾…æµ‹è¯•</span>
            </div>
            <button class="btn btn-primary" onclick="testSockJS()">æµ‹è¯•SockJS</button>
            <div id="sockjsResult" class="result info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <div class="test-header">
                <h3 class="test-title">ğŸ“¡ STOMPåº“æµ‹è¯•</h3>
                <span class="status" id="stompStatus">å¾…æµ‹è¯•</span>
            </div>
            <button class="btn btn-primary" onclick="testSTOMP()">æµ‹è¯•STOMP</button>
            <div id="stompResult" class="result info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <div class="test-header">
                <h3 class="test-title">ğŸ”„ å®Œæ•´åŠ è½½æµ‹è¯•</h3>
                <span class="status" id="fullStatus">å¾…æµ‹è¯•</span>
            </div>
            <button class="btn btn-primary" onclick="testFullLoad()">å®Œæ•´æµ‹è¯•</button>
            <div id="fullResult" class="result info" style="display: none;"></div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥å½“å‰åº“çŠ¶æ€
        function checkLibraries() {
            const status = document.getElementById('currentStatus');

            const checks = [
                { name: 'SockJS', check: typeof SockJS !== 'undefined', global: 'SockJS' },
                { name: 'window.SockJS', check: typeof window.SockJS !== 'undefined', global: 'window.SockJS' },
                { name: 'Stomp', check: typeof Stomp !== 'undefined', global: 'Stomp' },
                { name: 'window.Stomp', check: typeof window.Stomp !== 'undefined', global: 'window.Stomp' },
                { name: 'window.stomp', check: typeof window.stomp !== 'undefined', global: 'window.stomp' },
                { name: 'window.STOMP', check: typeof window.STOMP !== 'undefined', global: 'window.STOMP' }
            ];

            let result = 'ğŸ“Š åº“çŠ¶æ€æ£€æŸ¥ç»“æœï¼š\n\n';
            checks.forEach(check => {
                result += `${check.name}: ${check.check ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'} (${check.global})\n`;
            });

            // æ˜¾ç¤ºå…¨å±€å¯¹è±¡è¯¦æƒ…
            result += '\nğŸ” å…¨å±€å¯¹è±¡è¯¦æƒ…ï¼š\n';
            if (typeof SockJS !== 'undefined') {
                result += `SockJS: ${SockJS.constructor.name}\n`;
            }
            if (typeof Stomp !== 'undefined') {
                result += `Stomp: ${Stomp.constructor.name}\n`;
                if (Stomp.over) {
                    result += 'Stomp.over: âœ… å­˜åœ¨\n';
                }
            }

            status.textContent = result;
            status.className = 'result info';
        }

        // æµ‹è¯•SockJS
        async function testSockJS() {
            const status = document.getElementById('sockjsStatus');
            const result = document.getElementById('sockjsResult');

            status.textContent = 'æµ‹è¯•ä¸­...';
            status.className = 'status warning';

            try {
                if (typeof SockJS === 'undefined') {
                    throw new Error('SockJSæœªåŠ è½½');
                }

                // å°è¯•åˆ›å»ºSockJSå®ä¾‹
                const socket = new SockJS('http://localhost:8080/ws');

                result.textContent = 'âœ… SockJSå®ä¾‹åˆ›å»ºæˆåŠŸ\n' +
                                   `ç±»å‹: ${socket.constructor.name}\n` +
                                   `URL: ${socket.url}\n` +
                                   `åè®®: ${socket.protocol || 'æœªçŸ¥'}`;
                result.className = 'result success';
                result.style.display = 'block';

                status.textContent = 'æˆåŠŸ';
                status.className = 'status success';

                // æ¸…ç†
                socket.close();

            } catch (error) {
                result.textContent = `âŒ SockJSæµ‹è¯•å¤±è´¥: ${error.message}`;
                result.className = 'result error';
                result.style.display = 'block';

                status.textContent = 'å¤±è´¥';
                status.className = 'status error';
            }
        }

        // æµ‹è¯•STOMP
        async function testSTOMP() {
            const status = document.getElementById('stompStatus');
            const result = document.getElementById('stompResult');

            status.textContent = 'æµ‹è¯•ä¸­...';
            status.className = 'status warning';

            try {
                // æŸ¥æ‰¾STOMPå¯¹è±¡
                let StompClient = Stomp || window.Stomp || window.stomp || window.STOMP;

                if (!StompClient) {
                    throw new Error('STOMPå¯¹è±¡æœªæ‰¾åˆ°');
                }

                result.textContent = 'âœ… STOMPå¯¹è±¡æ‰¾åˆ°\n' +
                                   `å˜é‡å: ${StompClient === Stomp ? 'Stomp' :
                                             StompClient === window.Stomp ? 'window.Stomp' :
                                             StompClient === window.stomp ? 'window.stomp' :
                                             StompClient === window.STOMP ? 'window.STOMP' : 'æœªçŸ¥'}\n` +
                                   `ç±»å‹: ${StompClient.constructor.name}\n` +
                                   `overæ–¹æ³•: ${StompClient.over ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n` +
                                   `connectæ–¹æ³•: ${StompClient.connect ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`;
                result.className = 'result success';
                result.style.display = 'block';

                status.textContent = 'æˆåŠŸ';
                status.className = 'status success';

            } catch (error) {
                result.textContent = `âŒ STOMPæµ‹è¯•å¤±è´¥: ${error.message}`;
                result.className = 'result error';
                result.style.display = 'block';

                status.textContent = 'å¤±è´¥';
                status.className = 'status error';
            }
        }

        // å®Œæ•´åŠ è½½æµ‹è¯•
        async function testFullLoad() {
            const status = document.getElementById('fullStatus');
            const result = document.getElementById('fullResult');

            status.textContent = 'æµ‹è¯•ä¸­...';
            status.className = 'status warning';

            try {
                let log = 'ğŸš€ å¼€å§‹å®Œæ•´åº“åŠ è½½æµ‹è¯•...\n\n';

                // æ­¥éª¤1: åŠ è½½SockJS
                log += 'ğŸ“¥ æ­¥éª¤1: åŠ è½½SockJS...\n';
                if (typeof SockJS === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js');
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                log += `SockJS: ${typeof SockJS !== 'undefined' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;

                // æ­¥éª¤2: åŠ è½½STOMP
                log += '\nğŸ“¡ æ­¥éª¤2: åŠ è½½STOMP...\n';
                if (typeof Stomp === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js');
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„STOMPå˜é‡
                const stompVars = [Stomp, window.Stomp, window.stomp, window.STOMP];
                const stompVarNames = ['Stomp', 'window.Stomp', 'window.stomp', 'window.STOMP'];
                let stompFound = false;

                for (let i = 0; i < stompVars.length; i++) {
                    if (typeof stompVars[i] !== 'undefined') {
                        log += `${stompVarNames[i]}: âœ… æ‰¾åˆ°\n`;
                        stompFound = true;
                        break;
                    }
                }

                if (!stompFound) {
                    log += 'STOMP: âŒ æœªæ‰¾åˆ°ä»»ä½•STOMPå˜é‡\n';
                    throw new Error('STOMPåº“åŠ è½½å¤±è´¥');
                }

                // æ­¥éª¤3: åˆ›å»ºè¿æ¥æµ‹è¯•
                log += '\nğŸ”Œ æ­¥éª¤3: æµ‹è¯•è¿æ¥åˆ›å»º...\n';
                const socket = new SockJS('http://localhost:8080/ws');
                let StompClient = Stomp || window.Stomp || window.stomp || window.STOMP;
                const stompClient = StompClient.over(socket);

                log += 'SockJSå®ä¾‹: âœ… åˆ›å»ºæˆåŠŸ\n';
                log += 'STOMPå®¢æˆ·ç«¯: âœ… åˆ›å»ºæˆåŠŸ\n';

                // æ¸…ç†
                socket.close();

                log += '\nğŸ‰ å®Œæ•´æµ‹è¯•é€šè¿‡ï¼æ‰€æœ‰åº“éƒ½æ­£å¸¸åŠ è½½ã€‚';
                result.textContent = log;
                result.className = 'result success';
                result.style.display = 'block';

                status.textContent = 'æˆåŠŸ';
                status.className = 'status success';

            } catch (error) {
                let log = `âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}\n\n`;
                log += 'ğŸ” æ•…éšœæ’é™¤å»ºè®®:\n';
                log += '1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n';
                log += '2. ç¡®è®¤CDNæœåŠ¡å¯ç”¨\n';
                log += '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯\n';
                log += '4. å°è¯•åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½\n';

                result.textContent = log;
                result.className = 'result error';
                result.style.display = 'block';

                status.textContent = 'å¤±è´¥';
                status.className = 'status error';
            }
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error('åŠ è½½å¤±è´¥: ' + src));
                document.head.appendChild(script);

                setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶: ' + src)), 10000);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            checkLibraries();
        });
    </script>
</body>
</html>
