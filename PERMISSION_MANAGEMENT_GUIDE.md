# 权限管理系统使用指南

## 🎯 权限系统概述

系统实现了完整的文档权限管理，支持三种权限级别：

### 📋 权限级别说明

| 权限类型 | 权限说明 | 功能描述 |
|---------|---------|---------|
| **READ** | 只读权限 | 可以查看文档内容，但不能编辑 |
| **WRITE** | 读写权限 | 可以查看和编辑文档内容 |
| **ADMIN** | 管理员权限 | 可以管理文档权限，添加/修改/删除其他用户的权限 |

### 👑 特殊权限规则

1. **文档创建者**：自动拥有 `ADMIN` 权限，无法被移除或修改
2. **默认权限**：未明确设置权限的用户无法访问文档
3. **权限继承**：`ADMIN` 包含 `WRITE` 和 `READ` 权限，`WRITE` 包含 `READ` 权限

## 🚀 权限管理测试流程

### 第一阶段：权限系统验证

#### 步骤1：创建测试用户
```bash
# 注册三个测试用户
用户A (ID: 1) - testuser/123456 - 文档创建者
用户B (ID: 2) - ZSY/密码 - 普通用户
用户C (ID: 3) - 新注册用户 - 待分配权限用户
```

#### 步骤2：文档权限验证

**场景1：创建者权限**
1. 用户A 登录，创建新文档（文档ID: 10）
2. 用户A 自动获得 `ADMIN` 权限
3. 用户B 尝试编辑文档ID 10 → ❌ "无权限编辑此文档"

**场景2：权限分配**
1. 用户A 点击"检测权限" → 显示"管理员"
2. 用户A 点击"管理权限" → 打开权限管理界面
3. 用户A 为用户B 添加 `WRITE` 权限
4. 用户B 刷新页面，重新连接文档ID 10
5. 用户B 可以正常编辑文档

**场景3：权限修改**
1. 用户A 在权限管理界面修改用户B的权限为 `READ`
2. 用户B 失去编辑权限，只能查看文档

### 第二阶段：多用户协作权限测试

#### 步骤1：不同权限用户协作

**用户A (ADMIN)**：
- ✅ 可以编辑文档
- ✅ 可以管理权限
- ✅ 可以添加新用户权限

**用户B (WRITE)**：
- ✅ 可以编辑文档
- ✅ 可以查看权限列表
- ❌ 不能管理权限（无"管理权限"按钮）

**用户C (READ)**：
- ✅ 可以查看文档内容
- ❌ 不能编辑文档
- ❌ 不能查看权限列表

#### 步骤2：权限变更实时效果

1. **用户A** 将用户B权限改为 `READ`
2. **用户B** 立即失去编辑权限
3. **用户B** 刷新页面重新连接
4. **用户B** 只能查看，不能编辑

## 📱 前端权限管理界面

### 权限管理入口

在多用户测试页面侧边栏中：

```
🎛️ 测试控制
├── 🔌 连接到文档
├── 🔌 断开连接
├── ✏️ 模拟输入
├── 📤 发送测试操作
└── 🧹 清空日志

🛡️ 权限管理
├── 我的权限: [管理员/普通用户]
├── 🔍 检测权限
└── ⚙️ 管理权限 (仅管理员可见)
```

### 权限管理界面功能

#### 📋 权限列表查看
- 显示所有已设置权限的用户
- 实时显示权限类型（只读/读写/管理员）
- 支持权限修改和删除

#### 👥 添加用户权限
- 输入用户ID
- 选择权限类型（READ/WRITE/ADMIN）
- 一键添加权限

#### ✏️ 权限修改
- 下拉选择框快速修改权限
- 实时保存到后端

#### 🗑️ 权限删除
- 删除指定用户的权限
- 防止误操作的确认对话框

## 🔧 权限API接口

### 权限管理API

#### 1. 获取文档权限列表
```http
GET /api/permissions/document/{documentId}
Authorization: Bearer {token}
```
**权限要求**：当前用户必须有 ADMIN 权限

#### 2. 添加用户权限
```http
POST /api/permissions
Authorization: Bearer {token}
Content-Type: application/json

{
  "documentId": 1,
  "userId": 2,
  "permissionType": "WRITE"
}
```

#### 3. 修改用户权限
```http
PUT /api/permissions
Authorization: Bearer {token}
Content-Type: application/json

{
  "documentId": 1,
  "userId": 2,
  "permissionType": "READ"
}
```

#### 4. 删除用户权限
```http
DELETE /api/permissions?documentId=1&userId=2
Authorization: Bearer {token}
```

#### 5. 检查用户权限
```http
GET /api/permissions/check?documentId=1&userId=2&permissionType=WRITE
Authorization: Bearer {token}
```

## 🧪 权限测试场景

### 测试用例1：权限创建和验证
1. **创建者权限**：
   - 创建文档的用户自动获得 ADMIN 权限
   - 验证：`hasPermission(documentId, creatorId, "ADMIN")` 返回 `true`

2. **权限分配**：
   - 管理员为其他用户分配权限
   - 被分配用户立即获得相应权限

3. **权限检查**：
   - READ权限用户无法编辑
   - WRITE权限用户可以编辑但不能管理权限
   - ADMIN权限用户可以完全控制

### 测试用例2：权限变更实时生效
1. **动态权限变更**：
   - 管理员修改用户权限
   - 用户权限立即生效，无需重新登录

2. **权限移除**：
   - 管理员移除用户权限
   - 用户立即失去相应权限

### 测试用例3：权限边界测试
1. **创建者权限保护**：
   - 无法修改或删除创建者的权限
   - 创建者始终保持 ADMIN 权限

2. **权限类型验证**：
   - 只能设置有效的权限类型（READ/WRITE/ADMIN）
   - 无效权限类型会被拒绝

## 🚨 权限安全考虑

### 安全措施
1. **身份验证**：所有权限操作都需要有效的JWT token
2. **权限检查**：每次操作都验证当前用户的权限
3. **操作审计**：记录所有权限变更操作
4. **防止越权**：严格检查用户只能管理自己有权限的文档

### 权限检查逻辑
```java
// 检查是否有编辑权限
if (!permissionService.hasPermission(documentId, userId, "WRITE")) {
    throw new RuntimeException("无权限编辑此文档");
}

// 检查是否有管理权限
if (!permissionService.hasPermission(documentId, userId, "ADMIN")) {
    throw new RuntimeException("无权限管理文档权限");
}
```

## 🎯 权限系统优势

### 1. **灵活的权限控制**
- 支持三种权限级别
- 可以精细控制每个用户的权限
- 支持权限的动态修改

### 2. **安全可靠**
- 创建者权限不可剥夺
- 严格的权限验证
- 防止权限越界

### 3. **用户友好**
- 直观的权限管理界面
- 实时权限状态反馈
- 清晰的权限说明

### 4. **易于扩展**
- 模块化的权限服务
- 标准化的API接口
- 支持未来功能扩展

## 📈 使用建议

### 最佳实践
1. **合理分配权限**：根据用户角色分配适当权限
2. **定期检查权限**：定期审查和清理不必要的权限
3. **权限变更通知**：重要权限变更时通知相关用户
4. **权限审计**：记录权限变更历史便于追踪

### 权限分配建议
- **项目负责人**：ADMIN 权限
- **开发人员**：WRITE 权限
- **审核人员**：READ 权限（或根据需要）
- **访客/临时用户**：根据具体需求分配

---

## 🎊 权限管理系统现已完全就绪！

**开始测试完整的权限管理功能**：
1. 访问 `http://localhost:8080/multi-user-test.html`
2. 创建多个测试用户
3. 体验完整的权限分配和管理功能
4. 测试不同权限级别的用户协作

权限系统让你的多用户协作编辑器更加安全和可控！🛡️✨
