# Postman API 测试指南

本指南将帮助您使用 Postman 测试实时多人协同编辑系统的所有功能。

## 📋 目录

1. [准备工作](#准备工作)
2. [导入 Postman Collection](#导入-postman-collection)
3. [配置环境变量](#配置环境变量)
4. [测试流程](#测试流程)
5. [API 端点说明](#api-端点说明)
6. [常见问题](#常见问题)

## 🚀 准备工作

### 1. 确保服务运行

在开始测试之前，请确保：

- ✅ MySQL 数据库已启动并创建了 `collaborative_editor` 数据库
- ✅ Redis 服务已启动（默认端口 6379）
- ✅ Spring Boot 应用已启动（默认端口 8080）

### 2. 安装 Postman

如果还没有安装 Postman，请从 [Postman 官网](https://www.postman.com/downloads/) 下载并安装。

## 📥 导入 Postman Collection

1. 打开 Postman 应用
2. 点击左上角的 **Import** 按钮
3. 选择 **File** 标签页
4. 选择项目根目录下的 `Bysj_API_Collection.postman_collection.json` 文件
5. 点击 **Import** 完成导入

导入后，您将在左侧边栏看到 **Bysj API Collection** 集合。

## ⚙️ 配置环境变量

### 方法一：使用 Collection Variables（推荐）

Collection 已经预定义了以下变量：

- `base_url`: `http://localhost:8080`（API 基础 URL）
- `token`: （JWT 认证令牌，登录后自动设置）
- `user_id`: （用户 ID，登录后自动设置）
- `document_id`: （文档 ID，创建文档后自动设置）
- `comment_id`: （评论 ID，创建评论后自动设置）

如果您的服务运行在不同的端口，可以：

1. 右键点击 **Bysj API Collection**
2. 选择 **Edit**
3. 切换到 **Variables** 标签页
4. 修改 `base_url` 的值

### 方法二：创建 Postman Environment

1. 点击右上角的 **Environments** 图标（眼睛图标）
2. 点击 **+** 创建新环境
3. 添加以下变量：

| Variable | Initial Value | Current Value |
|----------|---------------|---------------|
| base_url | http://localhost:8080 | http://localhost:8080 |
| token | | |
| user_id | | |
| document_id | | |
| comment_id | | |

4. 保存环境并选择它作为当前环境

## 🧪 测试流程

### 第一步：用户注册和登录

1. **用户注册**
   - 打开 **用户相关** → **用户注册**
   - 修改请求体中的用户名、邮箱、密码等信息
   - 点击 **Send**
   - 预期：返回 200 状态码，包含用户 ID

2. **用户登录**
   - 打开 **用户相关** → **用户登录**
   - 使用注册时的用户名和密码
   - 点击 **Send**
   - 预期：返回 200 状态码，自动保存 `token` 和 `user_id` 到变量中

> 💡 **提示**：登录请求包含自动测试脚本，会自动将返回的 token 和 userId 保存到环境变量中。

### 第二步：文档管理

1. **创建文档**
   - 打开 **文档相关** → **创建文档**
   - 修改请求体中的 `title` 字段
   - 点击 **Send**
   - 预期：返回 200 状态码，自动保存 `document_id` 到变量中

2. **获取文档**
   - 打开 **文档相关** → **获取文档**
   - 点击 **Send**
   - 预期：返回文档详情

3. **获取用户的所有文档**
   - 打开 **文档相关** → **获取用户的所有文档**
   - 点击 **Send**
   - 预期：返回该用户创建的所有文档列表

4. **更新文档内容** ⭐
   - 打开 **文档相关** → **更新文档内容**
   - 修改请求体中的 `content` 字段为新的文档内容
   - 点击 **Send**
   - 预期：返回更新后的文档详情
   - **注意**：需要 WRITE 权限

5. **应用操作到文档（插入文本）** ⭐
   - 打开 **文档相关** → **应用操作到文档（插入文本）**
   - 修改请求体中的操作信息：
     - `type`: `INSERT`（插入操作）
     - `data`: 要插入的文本内容
     - `position`: 插入位置（从0开始）
     - `length`: 文本长度
   - 点击 **Send**
   - 预期：返回应用操作后的文档详情
   - **说明**：使用 OT 算法，支持并发编辑

6. **应用操作到文档（删除文本）** ⭐
   - 打开 **文档相关** → **应用操作到文档（删除文本）**
   - 修改请求体中的操作信息：
     - `type`: `DELETE`（删除操作）
     - `position`: 删除起始位置
     - `length`: 要删除的字符数
   - 点击 **Send**
   - 预期：返回应用操作后的文档详情

### 第三步：权限管理

1. **添加文档权限**
   - 打开 **权限相关** → **添加文档权限**
   - 修改请求体中的 `userId`（可以是另一个用户的 ID）
   - 设置 `permissionType` 为 `READ`、`WRITE` 或 `ADMIN`
   - 点击 **Send**
   - 预期：返回权限添加成功

2. **检查用户权限**
   - 打开 **权限相关** → **检查用户权限**
   - 修改查询参数中的 `userId` 和 `permissionType`
   - 点击 **Send**
   - 预期：返回是否有权限的布尔值

3. **获取文档的所有权限**
   - 打开 **权限相关** → **获取文档的所有权限**
   - 点击 **Send**
   - 预期：返回该文档的所有权限列表

4. **更新文档权限**
   - 打开 **权限相关** → **更新文档权限**
   - 修改 `permissionType`
   - 点击 **Send**

5. **删除文档权限**
   - 打开 **权限相关** → **删除文档权限**
   - 修改查询参数中的 `userId`
   - 点击 **Send**

### 第四步：评论功能

1. **创建评论**
   - 打开 **评论相关** → **创建评论**
   - 修改请求体中的 `content`、`position` 等字段
   - 点击 **Send**
   - 预期：返回评论详情，自动保存 `comment_id`

2. **获取文档的所有评论**
   - 打开 **评论相关** → **获取文档的所有评论**
   - 点击 **Send**
   - 预期：返回文档的所有评论

3. **获取根评论**
   - 打开 **评论相关** → **获取根评论**
   - 点击 **Send**
   - 预期：返回所有根评论（非回复）

4. **创建回复**
   - 打开 **评论相关** → **创建评论**
   - 设置 `parentId` 为某个评论的 ID
   - 点击 **Send**

5. **获取回复**
   - 打开 **评论相关** → **获取回复**
   - 点击 **Send**
   - 预期：返回指定评论的所有回复

6. **更新评论**
   - 打开 **评论相关** → **更新评论**
   - 修改请求体中的 `content` 或 `isResolved`
   - 点击 **Send**

7. **删除评论**
   - 打开 **评论相关** → **删除评论**
   - 点击 **Send**

### 第五步：版本管理

1. **创建版本快照**
   - 打开 **版本管理** → **创建版本快照**
   - 修改查询参数中的 `version`（例如：1）
   - 点击 **Send**
   - 预期：创建当前文档状态的快照

2. **获取文档的所有版本**
   - 打开 **版本管理** → **获取文档的所有版本**
   - 点击 **Send**
   - 预期：返回文档的所有版本列表

3. **获取指定版本的快照**
   - 打开 **版本管理** → **获取指定版本的快照**
   - 修改 URL 中的版本号（例如：将 `version/1` 改为 `version/2`）
   - 点击 **Send**
   - 预期：返回指定版本的快照内容

4. **回滚到指定版本**
   - 打开 **版本管理** → **回滚到指定版本**
   - 修改查询参数中的 `targetVersion`
   - 点击 **Send**
   - 预期：文档内容回滚到指定版本

### 第六步：文档导出

1. **导出为 PDF**
   - 打开 **文档导出** → **导出为PDF**
   - 点击 **Send**
   - 预期：下载 PDF 文件

2. **导出为 Word**
   - 打开 **文档导出** → **导出为Word**
   - 点击 **Send**
   - 预期：下载 Word 文件

3. **导出为 Markdown**
   - 打开 **文档导出** → **导出为Markdown**
   - 点击 **Send**
   - 预期：返回 Markdown 格式的文本

### 第七步：离线同步

1. **保存离线操作**
   - 打开 **离线同步** → **保存离线操作**
   - 修改请求体中的操作信息：
     - `type`: `insert`、`delete` 或 `retain`
     - `data`: 插入的文本内容
     - `position`: 操作位置
     - `length`: 操作长度
   - 点击 **Send**
   - 预期：离线操作保存成功

2. **获取离线操作列表**
   - 打开 **离线同步** → **获取离线操作列表**
   - 点击 **Send**
   - 预期：返回该文档的所有离线操作

3. **检查用户离线状态**
   - 打开 **离线同步** → **检查用户离线状态**
   - 点击 **Send**
   - 预期：返回离线状态和离线操作数量

4. **同步离线操作**
   - 打开 **离线同步** → **同步离线操作**
   - 点击 **Send**
   - 预期：返回同步后的操作列表

## 📚 API 端点说明

### 用户相关 (`/api/user`)

| 端点 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/register` | POST | 用户注册 | 否 |
| `/login` | POST | 用户登录 | 否 |
| `/{id}` | GET | 获取用户信息 | 是 |
| `/change-password` | POST | 修改密码 | 是 |

### 文档相关 (`/api/documents`)

| 端点 | 方法 | 说明 | 认证 | 权限 |
|------|------|------|------|------|
| `/` | POST | 创建文档 | 是 | - |
| `/{id}` | GET | 获取文档 | 是 | READ |
| `/user/{userId}` | GET | 获取用户的所有文档 | 是 | - |
| `/{id}/content` | PUT | 更新文档内容（直接更新） | 是 | WRITE |
| `/{id}/operation` | POST | 应用操作到文档（使用OT算法） | 是 | WRITE |
| `/{id}` | DELETE | 删除文档 | 是 | ADMIN |

### 评论相关 (`/api/comments`)

| 端点 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/` | POST | 创建评论 | 是 |
| `/document/{documentId}` | GET | 获取文档的所有评论 | 是 |
| `/document/{documentId}/root` | GET | 获取根评论 | 是 |
| `/{parentId}/replies` | GET | 获取回复 | 是 |
| `/{id}` | PUT | 更新评论 | 是 |
| `/{id}` | DELETE | 删除评论 | 是 |

### 权限相关 (`/api/permissions`)

| 端点 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/` | POST | 添加文档权限 | 是 |
| `/` | PUT | 更新文档权限 | 是 |
| `/` | DELETE | 删除文档权限 | 是 |
| `/document/{documentId}` | GET | 获取文档的所有权限 | 是 |
| `/check` | GET | 检查用户权限 | 是 |

### 版本管理 (`/api/versions`)

| 端点 | 方法 | 说明 | 认证 | 权限 |
|------|------|------|------|------|
| `/document/{documentId}` | GET | 获取文档的所有版本 | 是 | READ |
| `/document/{documentId}/version/{version}` | GET | 获取指定版本的快照 | 是 | READ |
| `/document/{documentId}/snapshot` | POST | 创建版本快照 | 是 | WRITE |
| `/document/{documentId}/rollback` | POST | 回滚到指定版本 | 是 | ADMIN |

### 文档导出 (`/api/export`)

| 端点 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/pdf/{documentId}` | GET | 导出为PDF | 是 |
| `/word/{documentId}` | GET | 导出为Word | 是 |
| `/markdown/{documentId}` | GET | 导出为Markdown | 是 |

### 离线同步 (`/api/offline`)

| 端点 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/operations` | POST | 保存离线操作 | 是 |
| `/operations/{documentId}` | GET | 获取离线操作列表 | 是 |
| `/sync/{documentId}` | POST | 同步离线操作 | 是 |
| `/status/{documentId}` | GET | 检查用户离线状态 | 是 |

## 🔐 认证说明

大部分 API 需要 JWT 认证。认证方式：

1. 在请求头中添加：
   ```
   Authorization: Bearer {token}
   ```

2. `token` 变量会在登录成功后自动设置。

3. 如果 token 过期，需要重新登录。

## ⚠️ 常见问题

### 1. 401 Unauthorized 错误

**原因**：Token 未设置或已过期

**解决方法**：
- 确保已执行登录请求
- 检查请求头中是否包含 `Authorization: Bearer {{token}}`
- 如果 token 过期，重新登录

### 2. 403 Forbidden 错误

**原因**：用户没有足够的权限

**解决方法**：
- 检查用户是否有相应的文档权限（READ/WRITE/ADMIN）
- 使用权限管理 API 添加相应权限

### 3. 404 Not Found 错误

**原因**：资源不存在或 URL 错误

**解决方法**：
- 检查 `document_id`、`user_id` 等变量是否正确设置
- 确认资源是否已创建

### 4. 变量未自动设置

**原因**：测试脚本未执行或执行失败

**解决方法**：
- 检查请求的响应状态码是否为 200
- 查看响应体格式是否正确
- 手动在环境变量中设置相应的值

### 5. 数据库连接错误

**原因**：数据库未启动或配置错误

**解决方法**：
- 确认 MySQL 服务已启动
- 检查 `application.properties` 中的数据库配置
- 确认数据库 `collaborative_editor` 已创建

### 6. Redis 连接错误

**原因**：Redis 未启动

**解决方法**：
- 确认 Redis 服务已启动（默认端口 6379）
- 检查 `application.properties` 中的 Redis 配置

## 💡 测试技巧

1. **使用 Collection Runner**：
   - 右键点击 Collection
   - 选择 **Run collection**
   - 可以批量运行所有请求

2. **保存响应示例**：
   - 在请求的 **Tests** 标签页中添加断言
   - 保存常用的响应作为示例

3. **使用 Pre-request Script**：
   - 在请求前自动设置变量
   - 生成动态数据（如时间戳）

4. **分组测试**：
   - 按照功能模块分组测试
   - 先测试基础功能（注册、登录），再测试高级功能

5. **多用户测试**：
   - 创建多个环境，每个环境使用不同的用户 token
   - 测试权限控制和协作功能

## 📝 注意事项

1. **测试顺序**：建议按照上述流程顺序测试，因为后续操作依赖前面的结果。

2. **文档编辑方式**：
   - **方式一（简单）**：使用 `PUT /api/documents/{id}/content` 直接更新整个文档内容
   - **方式二（推荐）**：使用 `POST /api/documents/{id}/operation` 通过操作（INSERT/DELETE）编辑文档，这种方式使用 OT 算法，支持并发编辑和冲突解决

3. **数据清理**：测试完成后，可能需要清理测试数据，避免影响后续测试。

4. **并发测试**：如需测试并发场景，可以使用 Postman 的 Collection Runner 或 Newman CLI。

5. **WebSocket 测试**：Postman 支持 WebSocket 连接，可以测试实时协作功能。

## 🎯 快速测试清单

- [ ] 用户注册
- [ ] 用户登录（自动保存 token）
- [ ] 创建文档（自动保存 document_id）
- [ ] 获取文档
- [ ] **更新文档内容** ⭐
- [ ] **应用操作到文档（插入/删除）** ⭐
- [ ] 添加文档权限
- [ ] 创建评论
- [ ] 创建版本快照
- [ ] 导出文档（PDF/Word/Markdown）
- [ ] 保存离线操作
- [ ] 同步离线操作

---

**祝测试顺利！如有问题，请查看项目文档或联系开发团队。**

